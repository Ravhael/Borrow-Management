import React, { useState } from 'react'
import {
  Box,
  Container,
  Typography,
  Paper,
  TextField,
  InputAdornment,
  IconButton,
  Button,
  Alert,
  Avatar,
  Fade,
  MenuItem,
  Divider,
} from '@mui/material'
import PersonIcon from '@mui/icons-material/Person'
import EmailIcon from '@mui/icons-material/Email'
import WorkIcon from '@mui/icons-material/Work'
import LockIcon from '@mui/icons-material/Lock'
import VisibilityIcon from '@mui/icons-material/Visibility'
import VisibilityOffIcon from '@mui/icons-material/VisibilityOff'
import Link from 'next/link'
import registerTheme from './RegisterTheme'

import directoratesData from '../../data/directorates.json'
import entitasData from '../../data/entitas.json'

interface FormData {
  username: string
  fullName: string
  whatsapp: string
  email: string
  role: string
  directorateId?: number | ''
  entitasId?: number | ''
  password: string
  confirmPassword: string
}

interface RegistrationFormProps {
  onSuccess: (formData: FormData) => void
}

const RegistrationForm: React.FC<RegistrationFormProps> = ({ onSuccess }) => {
  const [formData, setFormData] = useState<FormData>({
    username: '',
    fullName: '',
    whatsapp: '',
    email: '',
    role: '',
    directorateId: '',
    entitasId: '',
    password: '',
    confirmPassword: '',
  })

  const [showPassword, setShowPassword] = useState(false)
  const [showConfirmPassword, setShowConfirmPassword] = useState(false)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  const [rolesOptions, setRolesOptions] = useState<{ value: string; label: string }[]>([])
  const [rolesLoading, setRolesLoading] = useState(true)

  React.useEffect(() => {
    let mounted = true
    async function loadRoles(){
      try {
        const res = await fetch('/api/roles')
        const data = await res.json()
        if (!mounted) return
        if (data?.ok && Array.isArray(data.roles)){
          // hide superadmin from public registration
          const filtered = data.roles.filter((r: any) => String(r.id).toLowerCase() !== 'superadmin')
          setRolesOptions(filtered.map((r: any) => ({ value: r.id, label: r.name })))
        } else {
          // fallback to built-in options
          setRolesOptions([
            { value: 'user', label: 'Peminjam' },
            { value: 'marketing', label: 'Marketing Team' },
            { value: 'warehouse', label: 'Warehouse Operations' },
          ])
        }
      } catch (e) {
        console.error('Failed to load roles', e)
        setRolesOptions([
          { value: 'user', label: 'Peminjam' },
          { value: 'marketing', label: 'Marketing Team' },
          { value: 'warehouse', label: 'Warehouse Operations' },
        ])
      } finally {
        if (mounted) setRolesLoading(false)
      }
    }
    loadRoles()
    return () => { mounted = false }
  }, [])

  const handleInputChange = (field: keyof FormData) => (event: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [field]: event.target.value
    }))
    if (error) setError('')
  }

  const handleSelectChange = (field: keyof FormData) => (event: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [field]: event.target.value
    }))
  }

  // Entitas filtered based on selected directorate
  // Only show entitas when directorate is selected; otherwise empty list
  const entitasOptions = formData.directorateId ? entitasData.filter((e: any) => e.directorateId === Number(formData.directorateId)) : []

  const handleCheckboxChange = (field: keyof FormData) => (event: React.ChangeEvent<HTMLInputElement>) => {
    setFormData(prev => ({
      ...prev,
      [field]: event.target.checked
    }))
  }

  const validateForm = () => {
    if (!formData.username || !formData.fullName || !formData.email || !formData.password) {
      setError('Please fill in all required fields')
      return false
    }

    if (formData.password !== formData.confirmPassword) {
      setError('Passwords do not match')
      return false
    }

    if (formData.password.length < 8) {
      setError('Password must be at least 8 characters long')
      return false
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(formData.email)) {
      setError('Please enter a valid email address')
      return false
    }

    return true
  }

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault()
    setLoading(true)
    setError('')

    if (!validateForm()) {
      setLoading(false)
      return
    }

    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000))

      // For demo purposes, accept any registration
      // In a real app, this would create the user account
      onSuccess(formData)

    } catch (err) {
      setError('Registration failed. Please try again.')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Box
      sx={{
        pt: { xs: 12, md: 16 },
        pb: { xs: 8, md: 12 },
        minHeight: '100vh',
        display: 'flex',
        alignItems: 'center',
        background: `linear-gradient(135deg, ${registerTheme.palette.primary.dark} 0%, ${registerTheme.palette.primary.main} 50%, ${registerTheme.palette.secondary.main} 100%)`,
        position: 'relative',
        overflow: 'hidden',
        '&::before': {
          content: '""',
          position: 'absolute',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'url("data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23ffffff" fill-opacity="0.03"%3E%3Ccircle cx="30" cy="30" r="2"/3E%3C/g%3E%3C/g%3E%3C/svg%3E")',
        }
      }}
    >
      <Container maxWidth="md">
        <Fade in={true} timeout={1000}>
          <Paper
            elevation={24}
            sx={{
              p: { xs: 4, md: 6 },
              borderRadius: 4,
              background: 'rgba(255, 255, 255, 0.98)',
              backdropFilter: 'blur(20px)',
              border: '1px solid rgba(255, 255, 255, 0.2)',
            }}
          >
            <Box sx={{ textAlign: 'center', mb: 4 }}>
              <Avatar
                sx={{
                  width: 80,
                  height: 80,
                  bgcolor: 'white',
                  mx: 'auto',
                  mb: 3,
                  boxShadow: '0 8px 25px rgba(26, 54, 93, 0.2)',
                  border: `2px solid ${registerTheme.palette.primary.main}`,
                }}
              >
                <PersonIcon sx={{ fontSize: 40, color: registerTheme.palette.primary.main }} />
              </Avatar>
              <Typography variant="h4" sx={{ mb: 2, fontWeight: 700, color: registerTheme.palette.primary.main }}>
                Join FormFlow Today
              </Typography>
              <Typography variant="body1" color="text.secondary">
                Create your account and start streamlining your corporate loan management
              </Typography>
            </Box>

            {error && (
              <Alert severity="error" sx={{ mb: 3, borderRadius: 2 }}>
                {error}
              </Alert>
            )}

            <Box component="form" onSubmit={handleSubmit} sx={{ mb: 4 }}>
              {/* Username Field */}
              <TextField
                fullWidth
                label="Username"
                value={formData.username}
                onChange={handleInputChange('username')}
                required
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <PersonIcon color="primary" />
                    </InputAdornment>
                  ),
                }}
                placeholder="Choose a username"
                sx={{ mb: 3 }}
              />

              {/* Full name */}
              <TextField
                fullWidth
                label="Full Name"
                value={formData.fullName}
                onChange={handleInputChange('fullName')}
                required
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <PersonIcon color="primary" />
                    </InputAdornment>
                  ),
                }}
                placeholder="Enter your full name"
                sx={{ mb: 3 }}
              />

              {/* Whatsapp and Directorate/Entitas */}
              <Box sx={{ display: 'flex', gap: 2, mb: 3, flexDirection: { xs: 'column', sm: 'row' } }}>
                <TextField
                  fullWidth
                  label="No Whatsapp"
                  value={formData.whatsapp}
                  onChange={handleInputChange('whatsapp')}
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <PersonIcon color="primary" />
                      </InputAdornment>
                    ),
                  }}
                  placeholder="e.g. +62 812 3456 7890"
                />

                <TextField
                  fullWidth
                  select
                  label="Directorate"
                  value={String(formData.directorateId ?? '')}
                  onChange={(e) => setFormData(prev => ({ ...prev, directorateId: e.target.value ? Number(e.target.value) : '' }))}
                >
                  <MenuItem value="">None</MenuItem>
                  {directoratesData.map((d: any) => (
                    <MenuItem key={d.id} value={d.id}>{d.name}</MenuItem>
                  ))}
                </TextField>
              </Box>

              <Box sx={{ display: 'flex', gap: 2, mb: 3, flexDirection: { xs: 'column', sm: 'row' } }}>
                                <TextField
                  fullWidth
                  select
                  label="Entitas"
                  value={String(formData.entitasId ?? '')}
                  onChange={(e) => setFormData(prev => ({ ...prev, entitasId: e.target.value ? Number(e.target.value) : '' }))}
                  disabled={!formData.directorateId}
                  helperText={!formData.directorateId ? 'Silahkan Pilih Directorate terlebih dahulu' : ''}
                >
                  {formData.directorateId ? (
                    [<MenuItem key="none" value="">None</MenuItem>, ...entitasOptions.map((en: any) => (
                      <MenuItem key={en.id} value={en.id}>{en.name}</MenuItem>
                    ))]
                  ) : (
                    <MenuItem value="" disabled>Silahkan Pilih Directorate terlebih dahulu</MenuItem>
                  )}
                </TextField>
              </Box>

              {/* Contact Fields */}
              <Box sx={{ display: 'flex', gap: 2, mb: 3, flexDirection: { xs: 'column', sm: 'row' } }}>
                <TextField
                  fullWidth
                  label="Email Address"
                  type="email"
                  value={formData.email}
                  onChange={handleInputChange('email')}
                  required
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <EmailIcon color="primary" />
                      </InputAdornment>
                    ),
                  }}
                  placeholder="Enter your email address"
                />
              </Box>

              {/* Role */}
              <TextField
                fullWidth
                select
                label="Account Type"
                value={formData.role}
                onChange={handleInputChange('role')}
                sx={{ mb: 3 }}
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <WorkIcon color="primary" />
                      </InputAdornment>
                    ),
                  }}
                >
                  {rolesLoading ? (
                    <MenuItem value="" disabled>Loading roles...</MenuItem>
                  ) : (
                    rolesOptions.map(role => (
                      <MenuItem key={role.value} value={role.value}>{role.label}</MenuItem>
                    ))
                  )}
                </TextField>

              {/* Password Fields */}
              <Box sx={{ display: 'flex', gap: 2, mb: 3, flexDirection: { xs: 'column', sm: 'row' } }}>
                <TextField
                  fullWidth
                  label="Password"
                  type={showPassword ? 'text' : 'password'}
                  value={formData.password}
                  onChange={handleInputChange('password')}
                  required
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <LockIcon color="primary" />
                      </InputAdornment>
                    ),
                    endAdornment: (
                      <InputAdornment position="end">
                        <IconButton
                          onClick={() => setShowPassword(!showPassword)}
                          edge="end"
                        >
                          {showPassword ? <VisibilityOffIcon sx={{ color: registerTheme.palette.primary.main }} /> : <VisibilityIcon sx={{ color: registerTheme.palette.primary.main }} />}
                        </IconButton>
                      </InputAdornment>
                    ),
                  }}
                  placeholder="Create a strong password"
                  helperText="Must be at least 8 characters long"
                />
                <TextField
                  fullWidth
                  label="Confirm Password"
                  type={showConfirmPassword ? 'text' : 'password'}
                  value={formData.confirmPassword}
                  onChange={handleInputChange('confirmPassword')}
                  required
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <LockIcon color="primary" />
                      </InputAdornment>
                    ),
                    endAdornment: (
                      <InputAdornment position="end">
                        <IconButton
                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                          edge="end"
                        >
                          {showConfirmPassword ? <VisibilityOffIcon sx={{ color: registerTheme.palette.primary.main }} /> : <VisibilityIcon sx={{ color: registerTheme.palette.primary.main }} />}
                        </IconButton>
                      </InputAdornment>
                    ),
                  }}
                  placeholder="Confirm your password"
                />
              </Box>

              <Button
                type="submit"
                fullWidth
                variant="contained"
                size="large"
                disabled={loading}
                sx={{
                  mb: 3,
                  background: `linear-gradient(135deg, ${registerTheme.palette.primary.main} 0%, ${registerTheme.palette.primary.dark} 100%)`,
                  boxShadow: '0 4px 14px rgba(26, 54, 93, 0.25)',
                  '&:hover': {
                    background: `linear-gradient(135deg, ${registerTheme.palette.primary.dark} 0%, ${registerTheme.palette.primary.main} 100%)`,
                    transform: 'translateY(-2px)',
                    boxShadow: '0 8px 25px rgba(26, 54, 93, 0.3)',
                  },
                  transition: 'all 0.3s ease',
                }}
              >
                {loading ? 'Creating Account...' : 'Create Account'}
              </Button>
            </Box>

            <Box sx={{ textAlign: 'center' }}>
              <Typography variant="body2" color="text.secondary">
                Already have an account?{' '}
                <Link href="/login" passHref>
                  <Button
                    variant="text"
                    sx={{
                      color: registerTheme.palette.primary.main,
                      textTransform: 'none',
                      fontWeight: 600,
                      p: 0,
                      minWidth: 'auto',
                      '&:hover': {
                        backgroundColor: 'rgba(26, 54, 93, 0.04)',
                      }
                    }}
                  >
                    Sign in here
                  </Button>
                </Link>
              </Typography>
            </Box>
          </Paper>
        </Fade>
      </Container>
    </Box>
  )
}

export default RegistrationForm
